<div class="card custom-card mb-3" *ngIf="post">
  <div class="card-body p-0">
    
    <div class="p-3 d-flex align-items-center">
      <img [src]="post.author.avatarUrl" alt="Avatar" class="author-avatar rounded-circle me-3">
      <div>
        <h6 class="card-title mb-0 text-white fw-bold">{{ post.author.username }}</h6>
        <small class="text-secondary" style="font-size: 0.8rem;">{{ post.timeAgo }} · <i class="bi bi-globe-americas"></i></small>
      </div>
      <div class="ms-auto text-secondary options-icon"><i class="bi bi-three-dots"></i></div>
    </div>

    <div class="px-3 mb-3">
      <p class="card-text text-white mb-0">{{ post.content }}</p>
    </div>

    <div *ngIf="post.imageUrl" class="post-image-container mb-3" (click)="openModal()" style="cursor: pointer">
      <img [src]="post.imageUrl" class="img-fluid w-100" alt="Post content">
    </div>

    <div class="px-3 py-2 d-flex justify-content-between align-items-center border-bottom border-dark-subtle">
      <div class="d-flex align-items-center">
        <div class="reaction-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-1" *ngIf="post.likes > 0">
          <i class="bi bi-hand-thumbs-up-fill" style="font-size: 0.7rem;"></i>
        </div>
        <span class="text-secondary small">{{ post.likes }}</span>
      </div>
      
      <div class="text-secondary small">
        <span class="me-2 clickable-text" (click)="openModal()">
          {{ post.comments }} komentarzy
        </span>
        <span>{{ post.shares }} udostępnień</span>
      </div>
    </div>

    <div class="px-2 py-1 d-flex justify-content-between">
      <button class="btn btn-action flex-grow-1 fw-bold" (click)="toggleLike()"
              [class.text-primary]="post.isLikedByCurrentUser" [class.text-secondary]="!post.isLikedByCurrentUser">
        <i class="bi me-2" [class.bi-hand-thumbs-up-fill]="post.isLikedByCurrentUser" [class.bi-hand-thumbs-up]="!post.isLikedByCurrentUser"></i> 
        Lubię to!
      </button>
      
      <button class="btn btn-action flex-grow-1 text-secondary fw-bold" (click)="openModal()">
        <i class="bi bi-chat-left mb-1 me-2"></i> Komentarz
      </button>
      
      <button class="btn btn-action flex-grow-1 text-secondary fw-bold">
        <i class="bi bi-share me-2"></i> Udostępnij
      </button>
    </div>
  </div>
</div>

<div *ngIf="isModalOpen" class="post-modal-overlay" (click)="closeModal()">
  <div class="post-modal-content" (click)="$event.stopPropagation()">
    
    <button class="close-modal-btn" (click)="closeModal()">
      <i class="bi bi-x-lg"></i>
    </button>

    <div class="modal-body p-0">
      
      <div class="p-3">
        <div class="d-flex align-items-center mb-3">
          <img [src]="post.author.avatarUrl" class="rounded-circle me-2" style="width: 40px; height: 40px;">
          <div>
            <span class="text-white fw-bold d-block">{{ post.author.username }}</span>
            <small class="text-secondary">{{ post.timeAgo }}</small>
          </div>
        </div>
        <p class="text-white">{{ post.content }}</p>
        <img *ngIf="post.imageUrl" [src]="post.imageUrl" class="img-fluid rounded mb-0 w-100">
      </div>

      <div class="px-3 py-2 d-flex justify-content-between align-items-center border-bottom border-dark-subtle">
        <div class="d-flex align-items-center">
          <div class="reaction-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-1" *ngIf="post.likes > 0">
            <i class="bi bi-hand-thumbs-up-fill" style="font-size: 0.7rem;"></i>
          </div>
          <span class="text-secondary small">{{ post.likes }}</span>
        </div>
        
        <div class="text-secondary small">
          <span class="me-2 clickable-text" (click)="openModal()">
            {{ post.comments }} komentarzy
          </span>
          <span>{{ post.shares }} udostępnień</span>
        </div>
      </div>

      <hr class="border-dark-subtle m-0">

      <div class="px-2 py-1 d-flex justify-content-between">
        <button class="btn btn-action flex-grow-1 fw-bold" (click)="toggleLike()"
                [class.text-primary]="post.isLikedByCurrentUser" [class.text-secondary]="!post.isLikedByCurrentUser">
          <i class="bi me-2" [class.bi-hand-thumbs-up-fill]="post.isLikedByCurrentUser" [class.bi-hand-thumbs-up]="!post.isLikedByCurrentUser"></i> 
          Lubię to!
        </button>
        
        <button class="btn btn-action flex-grow-1 text-secondary fw-bold" (click)="openModal()">
          <i class="bi bi-chat-left mb-1 me-2"></i> Komentarz
        </button>
        
        <button class="btn btn-action flex-grow-1 text-secondary fw-bold">
          <i class="bi bi-share me-2"></i> Udostępnij
        </button>
      </div>

      <hr class="border-dark-subtle m-0">

      <div class="p-3 bg-dark-theme">
        
        <div *ngIf="isLoadingComments" class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="text-secondary mt-2">Ładowanie...</p>
        </div>

        <div *ngIf="!isLoadingComments">

          <ng-container *ngFor="let comment of post.commentsList">
             <ng-container *ngTemplateOutlet="commentTemplate; context: { $implicit: comment }"></ng-container>
          </ng-container>
          
          <ng-template #commentTemplate let-comment>

            <div class="d-flex">
              <img [src]="comment.author.avatarUrl" class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
              <div>
                <div class="bg-comment p-2 px-3">
                  <span class="text-white fw-bold d-block small">{{ comment.author.username }}</span>
                  <span class="text-white small">{{ comment.content }}</span>
                </div>
                
                <div class="ms-1 text-secondary d-flex align-items-center" style="font-size: 0.75rem;">
    
                  <span role="button" 
                        class="fw-bold d-flex align-items-center gap-1"
                        [class.text-primary]="comment.isLikedByCurrentUser"
                        (click)="toggleCommentLike(comment)"> Lubię to!
                  </span>

                  <span class="mx-1">·</span>
                  <span role="button">Odpowiedz</span>     
                  <span class="mx-1">·</span>     
                  <span>{{ comment.timeAgo }}</span>
                  <div class="reaction-icon bg-primary text-white rounded-circle d-flex align-items-center justify-content-center px-1 ms-2" *ngIf="comment.likes > 0">
                    <i class="bi bi-hand-thumbs-up-fill" style="font-size: 0.7rem;"></i>
                  </div>
                  <span *ngIf="comment.likes > 0" class="text-secondary ms-1">{{ comment.likes }}</span>
                </div>

                <div class="mb-2" >
                  <div *ngIf="comment.replyNumber > 0">
                    <span role="button" 
                          class="text-secondary fw-bold small d-flex align-items-center" 
                          (click)="toggleReplies(comment)">
                      
                      <i class="bi bi-arrow-return-right me-2"></i>
                      
                      <span *ngIf="!comment.isExpanded">
                        {{ comment.replyNumber > 1 ? 'Pokaż ' + comment.replyNumber + ' odpowiedzi' : 'Pokaż ' + comment.replyNumber + ' odpowiedź' }}
                      </span>
                      <span *ngIf="comment.isExpanded">
                        Ukryj odpowiedzi
                      </span>
                    </span>
                  </div>
                </div>

                <div *ngIf="comment.isExpanded" class="ms-1">
                   
                   <div *ngIf="comment.isLoadingReplies" class="py-2 text-center">
                      <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
                      <small class="text-secondary ms-2">Pobieranie...</small>
                   </div>

                   <ng-container *ngIf="!comment.isLoadingReplies && comment.replies">
                      <ng-container *ngFor="let reply of comment.replies">
                          <ng-container *ngTemplateOutlet="commentTemplate; context: { $implicit: reply }"></ng-container>
                      </ng-container>
                   </ng-container>

                </div>
                
              </div>
            </div>
          
          </ng-template>
        </div>
      </div>
      
    </div>
    
    <div class="p-3 your-comment-bg">
      <div class="d-flex align-items-center"> <img src="https://placehold.co/40/0d6efd/ffffff?text=User" class="rounded-circle me-2" style="width: 32px; height: 32px;">
        
        <input type="text" 
              #commentInput
              class="form-control rounded-pill border-0 your-comment-input flex-grow-1" 
              placeholder="Napisz komentarz..."
              [(ngModel)]="newCommentContent"
              (keyup.enter)="addComment()"
              [disabled]="isAddingComment">
          
          <button class="btn btn-sm btn-dark text-secondary d-flex align-items-center gap-2 ms-2"
                  (click)="addComment()"
                  [disabled]="isAddingComment || !newCommentContent.trim()">
                
                <i *ngIf="!isAddingComment" class="bi bi-send text-primary"></i>
                
                <div *ngIf="isAddingComment" class="spinner-border spinner-border-sm text-primary" role="status"></div>
          </button>

      </div>
    </div>

  </div>
</div>